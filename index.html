<!doctype html>
<html lang="en">
<head>
    <title>;-)</title>
    <style>
        #myul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 60%;
        }

            #myul li {
                margin: 0 3px 3px 3px;
                padding: 0.4em;
                padding-left: 1.5em;
                font-size: 1.4em;
                height: 18px;
            }

                #myul li span {
                    position: absolute;
                    margin-left: -1.3em;
                }

        #winky_top_menu {
            width: 100%;
            border-style: solid;
            border-width: 1px;
            list-style-type: none;
        }

            #winky_top_menu li {
                display: inline;
                border-right-style: solid;
                border-right-width: 1px;
            }
    </style>
</head>
<body>

    <ul id="winky_top_menu">
        <li><a href="#">Index</a></li>
        <li id="winky_edit_button">
            <!-- todo: is this sloppy to invoke js from an achor tag? -->
            <a href="javascript:Winky.edit_page()">Edit</a>
        </li>
        <li id="winky_save_button">
            <!-- todo: is this sloppy to invoke js from an achor tag? -->
            <a href="javascript:Winky.save_page()">Save</a>
        </li>
        <li id="winky_cancel_button">
            <!-- todo: is this sloppy to invoke js from an achor tag? -->
            <a href="javascript:Winky.cancel_edit()">Cancel</a>
        </li>
        <li id="winky_delete_button">
            <!-- todo: is this sloppy to invoke js from an achor tag? -->
            <a href="javascript:Winky.delete_page()">Delete</a>
        </li>
        <li id="winky_search_link"><a href="#search=">Search</a></li>
        <li id="winky_download_link_menu_item">
            <!-- todo: is this sloppy to invoke js from an achor tag? -->
            <a id="winky_download_link" href="" download="winky.html">Download</a>
            <!-- 
                http://stackoverflow.com/questions/3916191/download-data-url-file
                
                https://developer.mozilla.org/en-US/docs/Web/HTTP/data_URIs
                
                
                -->
        </li>
    </ul>
    
    <div id="winky_page_viewer">
    </div>
    
    <div id="winky_page_editor">
        <textarea name="winky_page_editor_name" id="winky_page_editor_textbox"></textarea>
    </div>
    
    <div id="winky_search_page">
        <textarea id="winky_search_text"></textarea>
        <button id="winky_search_button">Find</button>
        <ul id="winky_search_results">    
        </ul>
    </div>

    <!-- todo: replace the CDNs with imbeds to make fast and independent. -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.1/backbone-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
    <script>

        var Winky =
        {

//winky_pages_definition_start_a3nw047cjtu0894n904vumjrtcn49mr
            pages:
            {
                index: "hello there\n=========\nHere's some markup...\n\n[link to another page](winky:other-page1)\n\n[link to another page](winky:other-page2)",
                'other-page1': "This is the other page 1!\n=================\nblah blah yadda yadda"
            },
//winky_pages_definition_end_a3nw047cjtu0894n904vumjrtcn49mr

            view_page: function () {
                var page_name = Backbone.history.getFragment();
                page_name = !page_name || page_name == "" ? "index" : page_name; // todo:DRY

                if (page_name.startsWith('search='))
                {
                    Winky.view_search_page();
                    return;
                }

                if (!Winky.pages[page_name]) {
                    Winky.edit_page();
                    return;
                }

                // todo:databind the visibility so this show hide code doesn't have to be repeated.
                $('#winky_edit_button').show();
                $('#winky_save_button').hide();
                $('#winky_cancel_button').hide();
                $('#winky_page_viewer').show();
                $('#winky_page_editor').hide();
                $('#winky_search_page').hide();

                $('#winky_page_viewer').html(marked(Winky.pages[page_name]));
                $('#winky_page_viewer a[href^="winky:"]').each(function () {
                    var el = $(this);
                    el.attr('href', '#' + el.attr('href').substr('winky:'.length));
                })
            },

            edit_page: function () {
                var page_name = Backbone.history.getFragment();
                page_name = !page_name || page_name == "" ? "index" : page_name; // todo:DRY

                $('#winky_edit_button').hide();
                $('#winky_save_button').show();
                $('#winky_cancel_button').show();
                $('#winky_page_viewer').hide();
                $('#winky_page_editor').show();
                $('#winky_search_page').hide();

                if (Winky.pages[page_name]) {
                    $('#winky_page_editor_textbox').val(Winky.pages[page_name]);
                }
                else {
                    $('#winky_page_editor_textbox').val('');
                }
            },

            save_page: function () {
                var page_name = Backbone.history.getFragment();
                page_name = !page_name || page_name == "" ? "index" : page_name; // todo:DRY

                Winky.pages[page_name] = $('#winky_page_editor_textbox').val();
                
                Winky.update_download_url();

                Winky.view_page(page_name);
            },

            update_download_url: function()
            {
                // Could optimize this? Will be slow with big content?
                
                var currentAppSource = $('html').html();
                var startMarker = 'winky_pages_definition_start_a3nw047cjtu0894n904vumjrtcn49mr';
                var endMarker = 'winky_pages_definition_end_a3nw047cjtu0894n904vumjrtcn49mr';
                
                var startIndexOfContent = currentAppSource.indexOf(startMarker) + startMarker.length;
                var endIndexOfContent = currentAppSource.indexOf(endMarker) - 3;
                
                var sourceBeforeContent = currentAppSource.substr(0, startIndexOfContent);
                var sourceAfterContent = currentAppSource.substr(endIndexOfContent);
                
                var new_content = ['\n\npages: ', JSON.stringify(Winky.pages), ',\n\n'].join('');
                
                var href_val = 'data:,' + encodeURIComponent([sourceBeforeContent, new_content, sourceAfterContent].join(''));
                $('#winky_download_link').attr('href', href_val);
            },

            cancel_edit: function() {
                var page_name = Backbone.history.getFragment();
                page_name = !page_name || page_name == "" ? "index" : page_name; // todo:DRY
                
                Winky.view_page(page_name);
            },

            delete_page: function() {
                var page_name = Backbone.history.getFragment();
                page_name = !page_name || page_name == "" ? "index" : page_name; // todo:DRY
                
                delete Winky.pages[page_name];
                
                Winky.view_page("");
            },
            
            view_search_page: function()
            {
                $('#winky_edit_button').hide();
                $('#winky_save_button').hide();
                $('#winky_cancel_button').hide();
                $('#winky_page_viewer').hide();
                $('#winky_page_editor').hide();
                $('#winky_search_page').show();
                
                var page_name = Backbone.history.getFragment();
                var query = page_name.substr('search='.length);
                
                $('winky_search_text').val(query);
                
                var results = [];
                for (var content_page_name in Winky.pages)
                {
                    if (Winky.pages[content_page_name].includes(query))
                    {
                        results.push({
                            pn: content_page_name,
                            title: Winky.pages[content_page_name].substr(0, Winky.pages[content_page_name].indexOf('\n'))
                            });
                    }
                }
                
                results = _.sortBy(results, function(result){ return result.title; });
                var resultsHtml = [];
                for (var i = 0; i < results.length; i++)
                {
                    resultsHtml.push("<li><a href=\"#" + results[i].pn + "\">" + results[i].title + "</a></li>");
                }
                
                $('#winky_search_results').html(resultsHtml.join(''));
            },
            
            update_search: function()
            {
                var new_query = $('#winky_search_text').val();
                Winky.workspace.navigate("search=" + new_query, {trigger: true});
            }
        };

        Winky.Workspace = Backbone.Router.extend({

            routes: {
                "": "view_page",
                ":query": "view_page"
            },

            view_page: Winky.view_page
        });

        $(function () {
            
            Winky.workspace = new Winky.Workspace();
            Backbone.history.start();
            
            $('#winky_search_button').click(Winky.update_search);



        });


    </script>
</body>
</html>
